# demo.mapstory.org configuration
version: '3.1'
services:
  pgadmin:
    env_file:
      - docker/env/prod/db_auth.env
    ports:
      - "5050:5050"

  elasticsearch:
    ports:
      - "9200:9200"

  rabbitmq:
    image: rabbitmq:3.6-management
    environment:
      - RABBITMQ_DEFAULT_USER=mapstory
      - RABBITMQ_DEFAULT_PASS=password
      - RABBITMQ_DEFAULT_VHOST=mapstory
    ports:
      - "15672:15672"

  django:
    env_file:
      - docker/env/prod/public_host.env
      - docker/env/prod/geoserver.env
      - docker/env/prod/mapstory.env
      - docker/env/prod/db_auth.env
#    ports:
#      - "8000:8000"
    secrets:
      - social_auth

  celery:
    env_file:
      - docker/env/prod/public_host.env
      - docker/env/prod/geoserver.env
      - docker/env/prod/mapstory.env
      - docker/env/prod/db_auth.env
    volumes:
      - mapstory_media:/var/lib/mapstory/media/
      - mapstory_static:/var/lib/mapstory/static/
    secrets:
      - social_auth

  geoserver:
    env_file:
      - docker/env/prod/public_host.env
      - docker/env/prod/geoserver.env
      - docker/env/prod/db_auth.env
    volumes:
      - geoserver:/var/lib/geoserver
#    ports:
#      - "8080:8080"

  nginx:
    env_file:
      - docker/env/prod/public_host.env
    secrets:
      - ssl_cert
      - ssl_key

secrets:
  ssl_cert:
    file: secrets/ssl_cert
#    external: true
  ssl_key:
    file: secrets/ssl_key
#    external: true
  social_auth:
    file: secrets/social_auth
