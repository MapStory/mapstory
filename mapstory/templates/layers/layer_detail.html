{% extends "layers/layer_base.html" %}
{% load i18n %}
{% load dialogos_tags %}
{% load agon_ratings_tags %}
{% load bootstrap_tags %}
{% load url from future %}
{% load base_tags %}
{% load guardian_tags %}

{% block title %}{{ resource.title|default:resource.typename }} — {{ block.super }}{% endblock %}

{% block head %}
{% if preview == 'geoext' %}
  {% include "layers/layer_geoext_map.html" %}
{% else %}
  {% include "layers/layer_leaflet_map.html" %}
{% endif %}
{{ block.super }}
{% endblock %}


{% block body_class %}layers{% endblock %}

{% block body_outer %}
        <!-- dashboard -->
        <section class="slice" id="dashboard">
          <div class="container">
            <div class="row">
              <div class="col-sm-7" style="padding-right:15px;">
                <br>
                <div id="embedded_map" class="mrg-btm">
                  <div id="preview_map"></div>
                </div>
                <br>
                <div class="row">
                  <div class="col-sm-2">
                    <a href="{{ resource.owner.profile_detail_url}}"><img class="thumb img-responsive img-circle" src="{{ resource.owner.avatar_100}}"/></a>
                  </div>
                  <div class="col-sm-10">
                      <h2 style="font-size:1.5em">{{ resource.owner.first_name }} {{ resource.owner.last_name }}</h2>
                      <hr style="margin:5px">
                      <h2 style="font-size:1.2em;color:gainsboro">
                        <!-- TODO: Add Mapstory messaging functionality, has this been implemented? -->
                        <span style="color:orange">message</span> |
                        {% for social_link in social_links %}
                        {% ifequal social_link "twitter" %}
                          <a href="{{ social_link.url }}"><span style="color:deepskyblue">twitter</span></a> |
                        {% endifequal %}
                        {% ifequal social_link "facebook" %}
                          <a href="{{ social_link.url }}"><span style="color:dodgerblue">facebook</span></a>
                        {% endifequal %}
                        {% endfor %}
                      </h2>
                  </div>
                </div>
                <hr>
                <div class="row">
                  <div class="col-sm-12">
                    <article id="comments" class="tab-pane">
                      {% with resource as obj %}
                        {% include "_comments.html" %}
                      {% endwith %}
                    </article>
                  </div>
                </div>
              </div>
              <div class="col-sm-5" style="padding:15px">
                <div class="row">
                  <div class="col-sm-12">
                    <!-- <h1 style="font-weight:100;padding-top:10px;">Lorem Ipsum Dolor</h1> -->
                    <h2 class="page-title" style="padding-top:10px;">{{ resource.title|default:resource.typename }}</h2>
                  </div>
                </div>
                <hr style="margin-top:10px;margin-bottom:10px">
                <div class="row">
                  <div class="col-sm-9">
                    <h3 style="margin-top:0px;margin-bottom:5px;">Region: {{ resource.region_name_list.0 }} <!-- This inequality isn't working for some reason --> {% if resource.region_name_list|length > 1 %} and {{ resource.region_name_list|length|add:"-1" }} more...{% else %} {% endif %}</h3>
                    <h3 style="margin-top:0px;margin-bottom:5px;">Topic: {{ resource.category }}</h3>
                    <h3 style="margin-top:0px;margin-bottom:5px;">Tags:</h3>
                    <!-- NOTE: This has some formatting issues; needs to wrap around to a second line nicely -->
                    {% for keyword in resource.keyword_list|slice:"5" %}
                      <span class="label label-default">{{ keyword }}</span>
                    {% endfor %}
                    {% if resource.keyword_list|length > 5 %}
                      <span class="label label-default">{{ resource.keyword_list|length|add:"-5" }} more</span>
                    {% endif %}
                    <!-- Make this into a modal that spawns and lets us add a tag
                    Name of the tag to add:
                    ...that's it I guess
                     -->
                    <a href="#form_add_tag" data-toggle="modal"><span class="label label-default">+ <span contenteditable="true">add</span></span></a>
                    <!-- Modal for adding a tag (WIP) -->
                    {% comment %}
                    <!--
                    {% comment_form resource as form %}
                    <div id="form_add_tag" class="modal-fade" tabindex="-1" role="dialog">
                      <div class="modal-dialog">
                        <div class="modal-content">
                          <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                            <h4 class="modal-title">{% trans 'Add Tag' %}</h4>
                          </div> -->
                          <!-- TODO: Need to figure out how to add a keyword this way... what should action be?-->
                          <!--
                          <form action="{% comment_target resource %}" method="POST" id="form_post_tag">
                            <div class="modal-body">
                                {% csrf_token %}
                                {{ form|as_bootstrap }}
                            </div>
                            <div class="modal-footer">
                                <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                <button id="tag_submit_btn" class="btn btn-primary">{% trans 'Add Tag' %}</button>
                            </div>
                          </form>
                        </div>
                      </div>
                    </div> -->
                    
                    <!--
                    {% comment_form resource as form %}
                    <div id="form_add_tag" class="modal fade" tabindex="-1" role="dialog">
                        <div class="modal-dialog">
                          <div class="modal-content">
                            <div class="modal-header">
                              <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                              <h4 class="modal-title">{% trans 'Add Comment' %}</h4>
                            </div>
                            <form action="{% comment_target resource %}" method="POST" id="form_post_comment">
                              <div class="modal-body">
                                  {% csrf_token %}
                                  {{ form|as_bootstrap }}
                              </div>
                              <div class="modal-footer">
                                  <button class="btn" data-dismiss="modal" aria-hidden="true">{% trans "Cancel" %}</button>
                                  <button id="comment_submit_btn" class="btn btn-primary">{% trans 'Submit Comment' %}</button>
                              </div>
                            </form>
                          </div>
                        </div>
                    </div>
                  -->
                    {% endcomment %}

                    <hr style="margin-top:15px;margin-bottom:10px">
                    <h3 style="margin-top:0px;margin-bottom:5px;">
                      <article id="rate" class="tab-pane">
                        {% if request.user.is_authenticated %}
                        <h4>{% trans "Rate this layer" %}</h4>
                        {% user_rating request.user resource "layer" as user_layer_rating %}
                        <div id="user_rating" class="category-layer" data-score="{{ user_layer_rating }}" style="width: 100% !important;"></div>
                        {% endif %}        
                      </article>
                      
                      <!--
                      Rate:
                      <i class="fa fa-star-o"></i>
                      <i class="fa fa-star-o"></i>
                      <i class="fa fa-star-o"></i>
                      <i class="fa fa-star-o"></i>
                      <i class="fa fa-star-o"></i>
                    -->
                      <!--
                      Need to figure out how this is implemented...
                      Looks like an assignment tag probably but the name isn't found any
                      Looks like it uses jquery.raty.js but we want to change the styling of the stars
                      Looks like you can specify staroff and staron, but 
      <article id="rate" class="tab-pane">
        {% if request.user.is_authenticated %}
        <h4>{% trans "Rate this layer" %}</h4>
        {% user_rating request.user resource "layer" as user_layer_rating %}
        <div id="user_rating" class="category-layer" data-score="{{ user_layer_rating }}"></div>
        {% endif %}        
      </article>
-->
                    </h3>
                  </div>
                  <div class="col-sm-3" style="border-left:1px solid gainsboro">
                  <div style="text-align:right">
                    <a href="{% url "new_map" %}?layer={{resource.service_typename}}" >
                      <span style="font-size:1.3em;color:gainsboro">use</span>
                    </a>
                  </div>
                  <hr style="margin:5px">
                  <div style="text-align:right">
                    <a title="" href="#" target="blank">
                      <span style="font-size:1.3em;color:gainsboro"><a href='{% url "map-new2" %}?layer={{resource.service_typename}}'>edit</a></span>
                    </a>
                  </div>
                  <hr style="margin:5px">
                  <div style="text-align:right">
                    <a title="" href="#" target="blank">
                      <!-- TODO: Need to check if this user has already favorited this storylayer; toggle between adding/removing -->
                      <span style="font-size:1.3em;color:gainsboro">favorite</span>
                    </a>
                  </div>
                  <hr style="margin:5px">
                  <div style="text-align:right">
                    <a title="" href="#" target="blank">
                      <!-- TODO: Need to hook up functionality for flagging; presumably a modal spawns? -->
                      <span style="font-size:1.3em;color:gainsboro">flag</span>
                    </a>
                  </div>
                </div>
                </div>
                <hr style="margin-top:10px;margin-bottom:10px">
                
                <div class="row">
                  <div class="col-sm-12">
                    <ul class="nav nav-tabs">
                        <li class="active"><a href="#Summary" data-toggle="tab" style="font-size:0.8em;">Summary</a></li>
                        <li><a href="#Metadata" data-toggle="tab" style="font-size:0.8em;">Meta</a></li>
                        <li><a href="#Edits" data-toggle="tab" style="font-size:0.8em;">Edits</a></li>
                        <li><a href="#Download" data-toggle="tab" style="font-size:0.8em;">Download</a></li>
                        <li><a href="#Related" data-toggle="tab" style="font-size:0.8em;">Related</a></li>
                    </ul>
                    <div class="tab-content">
                      <div class="tab-pane active" id="Summary">
                        <div style="max-height:500px; overflow-y:scroll; overflow-x:hidden">
                          {{ resource.abstract }}
                        </div>
                      </div>
                      <div class="tab-pane" id="Metadata">
                        <table class="table table-condensed table-hover">
                          <tr>
                            <td width="35%">Topic</td>
                            <td width="65%">{{ resource.category }}</td>
                          </tr>
                          <tr>
                            <td width="35%">Language</td>
                            <!-- TODO: Change to human readable? Seems the language property may be abbreviated -->
                            <td width="65%"><i class="flag flag-us"></i>{{ resource.language }}</td>
                          </tr>
                          <tr>
                            <td width="35%">Data Source</td>
                            <td width="65%">{{ resource.distribution_url }}</td>
                          </tr> 
                          <tr>
                            <td width="35%">Data Quality Statement</td>
                            <td width="65%">{{ resource.data_quality_statement }}</td>
                          </tr>
                          <tr>
                            <td width="35%">Purpose</td>
                            <td width="65%">{{ resource.purpose }}</td>
                          </tr>   
                        </table>
                      </div>
                      <div class="tab-pane" id="Edits">
                        <div style="max-height:500px; overflow-y:scroll; overflow-x:hidden">
                          <table class="table table-condensed">
                        <tr>
                          <td>
                            <h2 style="margin:0px"><img class="img-circle" src="images/avatar.jpg" width="30"> Annie Butler</h2>
                          </td>
                          <td>
                            <i class="flag flag-us"></i> 
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <h2 style="margin:0px"><img class="img-circle" src="images/avatar.jpg" width="30"> Victor Reed</h2>
                          </td>
                          <td>
                            <i class="flag flag-ph"></i> 
                          </td>
                        </tr> 
                        <tr>
                          <td>
                            <h2 style="margin:0px"><img class="img-circle" src="images/avatar.jpg" width="30"> Charles Johnson</h2>
                          </td>
                          <td>
                            <i class="flag flag-gb"></i> 
                          </td>
                        </tr> 
                        <tr>
                          <td>
                            <h2 style="margin:0px"><img class="img-circle" src="images/avatar.jpg" width="30"> Evelyn Baker</h2>
                          </td>
                          <td>
                            <i class="flag flag-fr"></i> 
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <h2 style="margin:0px"><img class="img-circle" src="images/avatar.jpg" width="30"> Shawn Rivera</h2>
                          </td>
                          <td>
                            <i class="flag flag-de"></i> 
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <h2 style="margin:0px"><img class="img-circle" src="images/avatar.jpg" width="30"> Adam Russell</h2>
                          </td>
                          <td>
                            <i class="flag flag-at"></i> 
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <h2 style="margin:0px"><img class="img-circle" src="images/avatar.jpg" width="30"> Russell Lee</h2>
                          </td>
                          <td>
                            <i class="flag flag-it"></i> 
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <h2 style="margin:0px"><img class="img-circle" src="images/avatar.jpg" width="30"> Joe Kelly</h2>
                          </td>
                          <td>
                            <i class="flag flag-jp"></i> 
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <h2 style="margin:0px"><img class="img-circle" src="images/avatar.jpg" width="30"> Benjamin Wright</h2>
                          </td>
                          <td>
                            <i class="flag flag-cn"></i> 
                          </td>
                        </tr>
                        <tr>
                          <td>
                            <h2 style="margin:0px"><img class="img-circle" src="images/avatar.jpg" width="30"> Jimmy Washington</h2>
                          </td>
                          <td>
                            <i class="flag flag-ca"></i> 
                          </td>
                        </tr>
                      </table>
                        </div>
                      </div>
                      <div class="tab-pane" id="Download">
                        <div class="row">
                          <div class="col-sm-4" style="padding:5px">
                            <a class="btn btn-md btn-block" href="#" style="font-weight:100;background-color:white;color:red;border:1px solid red">CSV</a>
                          </div>
                          <div class="col-sm-4" style="padding:5px">
                            <a class="btn btn-md btn-block" href="#" style="background-color:white;color:green;border:1px solid green">XLS</a>
                          </div>
                          <div class="col-sm-4" style="padding:5px">
                            <a class="btn btn-md btn-block" href="#" style="background-color:white;color:blue;border:1px solid blue">SHP</a>
                          </div>
                          <div class="col-sm-4" style="padding:5px">
                            <a class="btn btn-md btn-block" href="#" style="background-color:white;color:purple;border:1px solid purple">GML</a>
                          </div>
                          <div class="col-sm-4" style="padding:5px">
                            <a class="btn btn-md btn-block" href="#" style="background-color:white;color:gold;border:1px solid gold">JSON</a>
                          </div>
                          <div class="col-sm-4" style="padding:5px">
                            <a class="btn btn-md btn-block" href="#" style="background-color:white;color:orange;border:1px solid orange">SLD</a>
                          </div>
                        </div>
                      </div>
                      <div class="tab-pane" id="Related">
                        <div style="max-height:500px; overflow-y:scroll; overflow-x:hidden">
                          <div class="col-sm-12">
                            <div class="row boxFeature">
                              <div class="col-xs-3">
                                <img src="images/portfolio/redlgpng.png" class="img-responsive"/>
                              </div>
                              <div class="col-xs-9">
                                <h3>Media Title</h3>
                                <p>Lorem ipsum dolor sit amet, modus utroque patrioque pro et, in zril maiorum voluptatibus nec.</p>
                              </div>
                            </div>
                          </div>
                          <div class="col-sm-12">
                            <div class="row boxFeature">
                              <div class="col-xs-3">
                                <img src="images/portfolio/yellowlgpng.png" class="img-responsive"/>
                              </div>
                              <div class="col-xs-9">
                                <h3>Media Title</h3>
                                <p>Lorem ipsum dolor sit amet, modus utroque patrioque pro et, in zril maiorum voluptatibus nec.</p>
                              </div>
                            </div>
                          </div>
                          <div class="col-sm-12">
                            <div class="row boxFeature">
                              <div class="col-xs-3">
                                <img src="images/portfolio/yellowlgpng.png" class="img-responsive"/>
                              </div>
                              <div class="col-xs-9">
                                <h3>Media Title</h3>
                                <p>Lorem ipsum dolor sit amet, modus utroque patrioque pro et, in zril maiorum voluptatibus nec.</p>
                              </div>
                            </div>
                          </div>
                          <div class="col-sm-12">
                            <div class="row boxFeature">
                              <div class="col-xs-3">
                                <img src="images/portfolio/yellowlgpng.png" class="img-responsive"/>
                              </div>
                              <div class="col-xs-9">
                                <h3>Media Title</h3>
                                <p>Lorem ipsum dolor sit amet, modus utroque patrioque pro et, in zril maiorum voluptatibus nec.</p>
                              </div>
                            </div>
                          </div>
                          <div class="col-sm-12">
                            <div class="row boxFeature">
                              <div class="col-xs-3">
                                <img src="images/portfolio/yellowlgpng.png" class="img-responsive"/>
                              </div>
                              <div class="col-xs-9">
                                <h3>Media Title</h3>
                                <p>Lorem ipsum dolor sit amet, modus utroque patrioque pro et, in zril maiorum voluptatibus nec.</p>
                              </div>
                            </div>
                          </div>
                    <a class="btn btn-sm btn-block" title="" href="#" target="blank">
                      <span style="font-size:1.2em">load more storylayers</span>
                    </a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

{% endblock %}

{% block extra_script %}

    {% if GEOGIG_ENABLED and resource.link_set.geogig %}
        {% with "_geogig_scripts.html" as geogig_scripts_template %}
            {% include  geogig_scripts_template %}
        {% endwith %}
    {% endif %}

    {% if request.user.is_authenticated %}
        {% user_rating_js request.user resource "layer" %}
    {% else %}
      {% overall_rating resource 'layer' as the_layer_rating %}
    {% endif %}
    {% include 'rating.html' %}
    {% include 'request_download.html' %}
    <script type="text/javascript">
       $("#comment_submit_btn").click(function(event) {
            $.ajax({
              type: "POST",
              url: $("#form_post_comment").attr('action'),
              data: $("#form_post_comment").serialize(),
              success: function() {
                $('#form_post_comment_div').modal('hide');
                $('#comments_section').load(window.location.pathname + ' #comments_section', 
                    function(){$(this).children().unwrap()})
              }
            });
            return false;
          });

    {% if resource.get_legend.link_type == 'json' %}
    $.getJSON('{{resource.get_legend_url}}', function (data) {
        var legend = data.layers[0].legend;
        var items = [];
        $.each(legend, function (key, dvalue) {
            items.push('<li><img src="data:image/png;base64,' + dvalue.imageData + '">'+dvalue.label+'</li>');
        });

        $('<ul/>', {
            'class': 'arcgis-legend',
            html: items.join('')

        }).appendTo('#legend_placeholder');

    });
    {% endif %}
        </script>
    <script type="text/javascript">
      $('#set_thumbnail').click(function(){
        createMapThumbnail();
        $('#edit-layer').modal('toggle');
      });
    </script>
    {% if GEONODE_SECURITY_ENABLED %}
    {% include "_permissions_form_js.html" %}
    {% endif %}
{% endblock extra_script %}